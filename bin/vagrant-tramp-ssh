#!/usr/bin/env bash
### vagrant-tramp-ssh --- connect to the named vagrant box

## Copyright © 2016  The Vagrant-Tramp Contributors
## Copyright © 2020  Ryan Prior <rprior@protonmail.com>

## Author: Ryan Prior <rprior@protonmail.com>

## This file is not part of GNU Emacs.

## vagrant-tramp is free software: you can redistribute it and/or
## modify it under the terms of the GNU General Public License as
## published by the Free Software Foundation, either version 3 of the
## License, or (at your option) any later version.

## This file is distributed in the hope that it will be useful, but
## WITHOUT ANY WARRANTY; without even the implied warranty of
## MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
## General Public License for more details.

## You should have received a copy of the GNU General Public License
## along with this file.  If not, see <http://www.gnu.org/licenses/>.


### Commentary:

## This is a program for establishing a connection to a Vagrant box. Emacs TRAMP
## will call it with a single argument containing a directory name and a box
## name, separated by the ASCII unit separator (hex code 1F). It looks in
## `vagrant global-status` to find the ID of that box and then uses `vagrant
## ssh` to connect. See vagrant-tramp.el for more details.

set -eu

IFS=$'\x1f' read dir_name name <<<"$1"
shift

if [[ ! "$name" ]]; then name="default"; fi

vagrant_machines() {
    vagrant global-status --machine-readable \
        | cut -d, -f5- \
        | awk '
begin { go = 0 }

$1 ~ /^-+$/ {
  go = 1;
  FS="\n";
  RS="\n\n";
  OFS="\x1f";
  ORS="\n";
}

go && $1 ~ /^[0-9a-f]+ *$/ {
  gsub(/ +$/, "", $1);
  gsub(/ +$/, "", $2);
  gsub(/ +$/, "", $5);
  print $1, $2, $5
}'
}

IFS=$'\x1f' read id dir <<<\
     $(vagrant_machines \
           | awk -v FS=$'\x1f' \
                 -v OFS=$'\x1f' \
                 -v name="$name" \
                 -v dir="$dir_name" \
                 '$2==name && $3~dir { print $1, $3 }')

cd "$dir"
exec vagrant ssh "$id" $@
